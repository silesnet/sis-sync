<?xml version="1.0" encoding="UTF-8"?>
<beans xmlns="http://www.springframework.org/schema/beans"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:p="http://www.springframework.org/schema/p"
	xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd">

	<bean
		class="org.springframework.beans.factory.config.PropertyPlaceholderConfigurer"
		p:systemPropertiesModeName="SYSTEM_PROPERTIES_MODE_OVERRIDE">
		<property name="locations">
			<list>
				<value>batch.properties</value>
				<value>jbdc.properties</value>
			</list>
		</property>
	</bean>

	<bean id="jobLancher"
		class="org.springframework.batch.core.launch.support.SimpleJobLauncher"
		p:jobRepository-ref="jobRepository" />

	<bean id="jobRepository"
		class="org.springframework.batch.core.repository.support.MapJobRepositoryFactoryBean"
		p:transactionManager-ref="transactionManager" />

	<bean id="transactionManager"
		class="org.springframework.batch.support.transaction.ResourcelessTransactionManager" />

	<bean id="dataSource" class="org.apache.commons.dbcp.BasicDataSource"
		p:driverClassName="${jdbc.driver}" p:url="${jdbc.url}" p:username="${jdbc.user}"
		p:password="${jdbc.password}" />

	<bean id="jdbcTemplate" class="org.springframework.jdbc.core.JdbcTemplate"
		p:dataSource-ref="dataSource" />

	<bean id="sisInvoiceJob" class="org.springframework.batch.core.job.SimpleJob"
		p:jobRepository-ref="jobRepository">
		<property name="steps">
			<list>
			</list>
		</property>
	</bean>

	<bean id="sisInvoiceStep"
		class="org.springframework.batch.core.step.item.SimpleStepFactoryBean"
		p:jobRepository-ref="jobRepository" p:transactionManager-ref="transactionManager">
	</bean>

	<bean id="invoiceItemReader"
		class="org.springframework.batch.item.database.DrivingQueryItemReader">
		<property name="keyCollector">
			<bean
				class="org.springframework.batch.item.database.support.SingleColumnJdbcKeyCollector"
				p:jdbcTemplate-ref="jdbcTemplate">
				<property name="keyMapper">
					<bean class="cz.silesnet.sis.sync.mapping.InvoiceRowMapper">
						<property name="dao">
							<bean class="cz.silesnet.sis.sync.dao.impl.JdbcInvoiceDao"
								p:template-ref="jdbcTemplate" />
						</property>
					</bean>
				</property>
				<property name="sql">
					<value><![CDATA[
                       SELECT id FROM invoices
                         WHERE synchronized IS NULL
                         ORDER BY id
                    ]]></value>
				</property>
				<property name="restartSql">
					<value><![CDATA[
                       SELECT id FROM invoices
                         WHERE synchronized IS NULL
                           AND id > ?
                         ORDER BY id
                    ]]></value>
				</property>
			</bean>
		</property>
	</bean>

</beans>
